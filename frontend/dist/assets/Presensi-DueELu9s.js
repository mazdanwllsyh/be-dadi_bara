import{r as s,d as ee,u as ae,j as e,S as W,C as q,D as C,E as f,a5 as j,ap as D,J as F,a3 as t,y as v}from"./vendor-Cul97NbA.js";import{U as te,i as A}from"./index-STTFwuxj.js";const re=()=>{const{user:n}=s.useContext(te),K=ee(),_=ae(),[y,J]=s.useState([]),[I,U]=s.useState([]),[h,P]=s.useState(""),[z,T]=s.useState(!0),[x,E]=s.useState(""),[$,S]=s.useState(""),[M,G]=s.useState(""),[H,k]=s.useState(!1),[b,w]=s.useState(""),[R,B]=s.useState(!1);s.useEffect(()=>{(async()=>{T(!0);try{const[r,p]=await Promise.all([A.get("/jadwal-kegiatan"),A.get("/members")]),l=(r.data||[]).sort((o,c)=>{const u=new Date(`${c.tanggal.substring(0,10)}T${c.waktu}`),m=new Date(`${o.tanggal.substring(0,10)}T${o.waktu}`);return u-m}).slice(0,6);J(l),U(p.data||[])}catch{v.error("Gagal memuat data awal.")}finally{T(!1)}})()},[]),s.useEffect(()=>{if(!h){k(!1),w("");return}const a=y.find(g=>g._id===h);if(!a)return;const[r,p,i]=a.tanggal.substring(0,10).split("-").map(Number),[l,o]=a.waktu.split(":").map(Number),c=new Date(r,p-1,i,l,o),u=c,m=new Date(c.getTime()+1440*60*1e3);let d;const N=()=>{const g=new Date;if(g>=u&&g<=m)k(!0),w(""),d&&clearInterval(d);else if(g<u){k(!1);const L=u-g,X=Math.floor(L/(1e3*60*60)),Y=Math.floor(L/1e3/60%60),Z=Math.floor(L/1e3%60);w(`${X.toString().padStart(2,"0")}:${Y.toString().padStart(2,"0")}:${Z.toString().padStart(2,"0")}`)}else k(!1),w("Waktu presensi sudah berakhir."),d&&clearInterval(d)};return N(),d=setInterval(N,1e3),()=>clearInterval(d)},[h,y]);const Q=()=>{n||K("/login",{state:{background:_}})},O=s.useMemo(()=>{const a=x.trim();if(!a)return S(""),"";const r=a.toLowerCase(),p=r.split(/\s+/);let i=null,l=0;return I.forEach(o=>{const c=o.nama.toLowerCase();if(c===r){i=o,l=100;return}if(l===100)return;const u=c.split(/\s+/);let m=0;p.forEach(d=>{u.some(N=>N.startsWith(d))&&m++}),m>l&&(l=m,i=o)}),i?(S(i.nama),i.titleLabel):(S(""),"Anggota")},[x,I]);s.useEffect(()=>{n&&E(n.fullName||"")},[n]);const V=async a=>{if(a.preventDefault(),M.trim().toLowerCase()!=="hadir")return v.warn('Harap ketik "HADIR" dengan benar untuk konfirmasi.');B(!0);try{const r={kegiatanId:h,nama:$||x,email:n?.email,jabatan:O};await A.post("/presensi",r,{withCredentials:!0}),v.success(`Terima kasih, ${$||x}. Kehadiran Anda telah dicatat!`),P(""),G("")}catch(r){v.error(r.response?.data?.message||"Gagal mengirim presensi.")}finally{B(!1)}};return z?e.jsx("div",{className:"text-center d-flex justify-content-center align-items-center my-5 vh-100",children:e.jsx(W,{})}):n&&(n.role==="admin"||n.role==="superAdmin")?e.jsx("section",{id:"admin-warning",className:"d-flex justify-content-center align-items-center vh-100",children:e.jsx(q,{children:e.jsx(C,{className:"justify-content-center",children:e.jsx(f,{md:8,lg:6,children:e.jsx(j,{className:"text-center shadow p-4",children:e.jsxs(j.Body,{children:[e.jsxs(D,{variant:"warning",children:[e.jsxs(D.Heading,{as:"h3",className:"text-danger section-title",children:["Perhatian untuk"," ",n.role==="superAdmin"?"Super Admin":"Admin"]}),e.jsx("p",{children:"Halaman ini ditujukan untuk presensi anggota. Mohon gunakan email pribadi Anda untuk melakukan presensi."}),e.jsx("hr",{}),e.jsx("p",{className:"mb-0",children:"Terima kasih."})]}),e.jsx(F,{variant:"outline-secondary",onClick:()=>K("/admin"),children:"Kembali ke Dashboard"})]})})})})})}):e.jsx("section",{id:"userprofile",className:"d-flex justify-content-center align-items-center vh-100",children:e.jsx(q,{className:"my-2",children:e.jsxs(j,{className:"shadow p-4",children:[e.jsx(j.Header,{className:"border-0 text-center",children:e.jsx("h2",{className:"section-title mb-0",children:"Formulir Presensi Kegiatan"})}),e.jsx(j.Body,{className:"p-0",children:e.jsxs(t,{onSubmit:V,className:"my-2",children:[e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"*Pilih Kegiatan"}),e.jsxs(t.Select,{value:h,onChange:a=>P(a.target.value),required:!0,className:"form-select text-center",children:[e.jsx("option",{value:"",disabled:!0,children:"-- Pilih Kegiatan yang Akan Diikuti --"}),y.map(a=>e.jsxs("option",{value:a._id,children:[a.nama," - (",new Date(a.tanggal).toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"}),")"]},a._id))]})]}),h&&(H||b)&&e.jsxs(e.Fragment,{children:[e.jsx("hr",{}),e.jsxs(C,{children:[e.jsx(f,{xs:12,md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"*Email"}),e.jsx(t.Control,{type:"email",value:n?.email||"",placeholder:n?"":"Klik di sini untuk Login",readOnly:!0,onClick:Q,style:{cursor:n?"not-allowed":"pointer"}})]})}),e.jsx(f,{xs:12,md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"*Nama Lengkap/Asli"}),e.jsx(t.Control,{type:"text",placeholder:"Masukkan nama lengkap Anda...",value:x,onChange:a=>E(a.target.value),required:!0})]})})]}),e.jsxs(C,{children:[e.jsx(f,{xs:12,md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"*Jabatan Terverifikasi (Otomatis Terisi)"}),e.jsx(t.Control,{type:"text",value:O||"Isi Nama Anda dengan Benar",readOnly:!0,style:{cursor:"not-allowed"}})]})}),e.jsx(f,{xs:12,md:6,children:e.jsxs(t.Group,{className:"mb-3",children:[e.jsx(t.Label,{children:"*Konfirmasi Kehadiran"}),e.jsx(t.Control,{type:"text",placeholder:'Ketik "HADIR"',value:M,onChange:a=>G(a.target.value),required:!0})]})})]}),e.jsx("div",{className:"text-center mt-4",children:H?e.jsx(F,{type:"submit",variant:"primary",className:"w-50",disabled:R,children:R?e.jsx(W,{size:"sm"}):"HADIR"}):e.jsx(D,{variant:"warning",children:b.includes(":")?`Presensi akan terbuka dalam: ${b}`:b})})]})]})})]})})})};export{re as default};
